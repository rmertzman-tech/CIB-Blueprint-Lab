<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The CIB Blueprint Laboratory</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #111827; color: #f3f4f6; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        // Safely access Recharts only after component mount or check for window.Recharts
        const Recharts = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = Recharts;

        // --- PHYSICS CONSTANTS (UCP v2.0) ---
        const PARAMS = {
            LANDAUER_COST: 0.8,      // Energy cost per bit of depth
            THETA_CRIT: 75,          // Sapolsky Limit (Stress Threshold)
            REWRITE_COST: 40,        // Entropy spike during transformation
            METABOLIC_RECOVERY: 5,   // Energy gain per tick
            MAX_ENERGY: 100,
            PRIME_BASE: 3,           // Branching factor for visual tree
        };

        // --- COMPONENT: THE P-ADIC TREE VISUALIZER ---
        const PAdicTree = ({ depth, truncatedDepth, isRewriting, entropy }) => {
            const canvasRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;

                ctx.clearRect(0, 0, width, height);

                // Dynamic color based on state
                let strokeColor = '#4ade80'; // Green (Healthy)
                if (isRewriting) strokeColor = '#facc15'; // Yellow (Flux/Cryptic)
                if (truncatedDepth < depth) strokeColor = '#ef4444'; // Red (Truncated/Stress)

                const drawBranch = (x, y, len, angle, branchDepth) => {
                    ctx.beginPath();
                    ctx.save();
                    ctx.strokeStyle = strokeColor;
                    ctx.fillStyle = strokeColor;
                    ctx.lineWidth = Math.max(1, 4 - branchDepth * 0.5);
                    ctx.translate(x, y);
                    ctx.rotate(angle * Math.PI / 180);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(0, -len);
                    ctx.stroke();

                    if (branchDepth < depth) {
                        // If we are deeper than truncation, draw as "Ghost" (Grey)
                        if (branchDepth >= truncatedDepth) {
                            ctx.strokeStyle = '#374151'; // Grey
                            ctx.setLineDash([5, 5]); // Dashed line for potential but inaccessible depth
                        } else {
                            ctx.setLineDash([]);
                        }
                        
                        // Recursive branching
                        const newLen = len * 0.75;
                        // Jitter based on entropy (Visualizing "Noise")
                        const jitter = (Math.random() - 0.5) * entropy * 0.5; 
                        
                        drawBranch(0, -len, newLen, -25 + jitter, branchDepth + 1);
                        drawBranch(0, -len, newLen, 25 + jitter, branchDepth + 1);
                    }
                    ctx.restore();
                };

                // Draw Trunk (Root)
                drawBranch(width / 2, height - 20, 60, 0, 0);

            }, [depth, truncatedDepth, isRewriting, entropy]);

            return <canvas ref={canvasRef} width={300} height={300} className="mx-auto" />;
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            // --- STATE ---
            const [depth, setDepth] = useState(2); // Current Logical Depth
            const [energy, setEnergy] = useState(80); // Metabolic Budget
            const [stress, setStress] = useState(10); // L_GC (Entropy)
            const [isRewriting, setIsRewriting] = useState(false); // "Cryptic State"
            const [history, setHistory] = useState([]);
            const [tick, setTick] = useState(0);
            const [message, setMessage] = useState("System Stable. Ready for Construction.");

            // Derived State
            const maintenanceCost = depth * PARAMS.LANDAUER_COST + (stress * 0.1);
            // Sapolsky Function: If stress > threshold, effective depth drops
            const truncatedDepth = stress > PARAMS.THETA_CRIT ? Math.max(1, Math.floor(depth * 0.3)) : depth;
            const isTruncated = truncatedDepth < depth;

            // --- GAME LOOP ---
            useEffect(() => {
                const interval = setInterval(() => {
                    setTick(t => t + 1);

                    // 1. Recover Energy
                    setEnergy(e => Math.min(PARAMS.MAX_ENERGY, e + PARAMS.METABOLIC_RECOVERY - maintenanceCost));

                    // 2. Reduce Stress (Natural Cooling)
                    setStress(s => Math.max(5, s - 2));

                    // 3. Handle Rewrite State (Metamorphosis)
                    if (isRewriting) {
                        setStress(s => s + 5); // Rewrite generates entropy
                        setEnergy(e => e - 2); // Rewrite consumes extra energy
                        
                        // Random chance to stabilize or fail based on energy
                        if (energy < 10) {
                            setIsRewriting(false);
                            setMessage("CRITICAL FAILURE: Energy depleted during metamorphosis. Reverting.");
                            setStress(90); // Trauma spike
                        } else if (Math.random() < 0.1) {
                            // Success!
                            setIsRewriting(false);
                            setDepth(d => d + 3); // Jump in depth
                            setStress(20); // Relief
                            setMessage("Transformation Complete! New CIB Architecture installed.");
                        }
                    }

                    // 4. Record History for Chart
                    setHistory(prev => {
                        const newPoint = { 
                            name: tick, 
                            Depth: depth, 
                            EffectiveDepth: truncatedDepth,
                            Energy: energy, 
                            Stress: stress 
                        };
                        const newHist = [...prev, newPoint];
                        return newHist.slice(-50); // Keep last 50 ticks
                    });

                }, 500); // 500ms tick

                return () => clearInterval(interval);
            }, [depth, energy, stress, isRewriting, maintenanceCost, tick]);

            // --- ACTIONS ---

            const handleConstruct = () => {
                if (isRewriting) return;
                if (energy < 20) {
                    setMessage("Not enough metabolic budget to learn.");
                    return;
                }
                setDepth(d => d + 1);
                setEnergy(e => e - 10); // Cost of construction
                setStress(s => s + 5); // Learning adds mild stress
                setMessage("Additive Change: Added 1 layer to CIB.");
            };

            const handleRewrite = () => {
                if (isRewriting) return;
                if (energy < 50) {
                    setMessage("Cannot initiate Metamorphosis: Energy too low.");
                    return;
                }
                setIsRewriting(true);
                setStress(s => s + 30); // Instant Entropy Spike
                setDepth(d => Math.floor(d * 0.5)); // Dissolution Phase (Soup)
                setMessage("Transformative Change Initiated: CIB structure dissolving...");
            };

            const handleStressSpike = () => {
                setStress(s => Math.min(100, s + 40));
                setMessage("External Shock! Cortisol spike detected.");
            };

            // Icons
            const BrainIcon = () => <i data-lucide="brain" className="w-8 h-8 mr-2 text-green-400"></i>;
            const AlertTriangleIcon = () => <i data-lucide="alert-triangle" className="w-4 h-4 mr-1"></i>;
            const RefreshCwIcon = () => <i data-lucide="refresh-cw" className="w-4 h-4 mr-1"></i>;
            const ZapIcon = () => <i data-lucide="zap" className="w-4 h-4 text-yellow-400 mr-1"></i>;
            const ThermometerIcon = () => <i data-lucide="thermometer" className="w-4 h-4 text-red-400 mr-1"></i>;
            const GitBranchIcon = () => <i data-lucide="git-branch" className="w-6 h-6 text-green-400 mb-1"></i>;
            
            // Re-run lucide.createIcons() after render
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            });

            if (!LineChart) {
                return <div className="text-white p-4">Loading Visualization Library...</div>;
            }

            return (
                <div className="p-4 max-w-4xl mx-auto bg-gray-900 text-gray-100 min-h-screen font-sans">
                    <header className="mb-6 border-b border-gray-700 pb-4">
                        <h1 className="text-3xl font-bold flex items-center text-green-400">
                            <BrainIcon />
                            The CIB Blueprint Laboratory
                        </h1>
                        <p className="text-gray-400 mt-2">
                            UCP v2.0 Simulation: Managing the Thermodynamics of Agency
                        </p>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        {/* LEFT COLUMN: VISUALIZATION */}
                        <div className="bg-gray-800 p-6 rounded-lg shadow-lg border border-gray-700">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="text-xl font-semibold">Internal Geometry (P-Adic Tree)</h2>
                                {isTruncated && <span className="text-red-500 font-bold flex items-center animate-pulse"><AlertTriangleIcon /> TRUNCATED</span>}
                                {isRewriting && <span className="text-yellow-400 font-bold flex items-center animate-pulse"><RefreshCwIcon /> REWRITING...</span>}
                            </div>
                            
                            <div className="bg-gray-900 rounded-lg flex items-center justify-center border border-gray-700 relative">
                                <PAdicTree depth={depth} truncatedDepth={truncatedDepth} isRewriting={isRewriting} entropy={stress} />
                                
                                {/* Overlay Metrics */}
                                <div className="absolute top-2 left-2 text-xs text-gray-400 space-y-1">
                                    <div>Logical Depth (L): <span className="text-white font-mono">{depth}</span></div>
                                    <div>Effective Depth: <span className={`${isTruncated ? 'text-red-500' : 'text-green-500'} font-mono`}>{truncatedDepth}</span></div>
                                    <div>Maintenance Cost: <span className="text-red-400 font-mono">{maintenanceCost.toFixed(1)}/tick</span></div>
                                </div>
                            </div>

                            <div className="mt-4 p-3 bg-black/30 rounded border border-gray-600 min-h-[60px]">
                                <p className="text-sm font-mono text-green-300">System Log: {message}</p>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: CONTROLS & METRICS */}
                        <div className="space-y-6">
                            
                            {/* METERS */}
                            <div className="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4">
                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="flex items-center"><ZapIcon /> Metabolic Budget (C_PFC)</span>
                                        <span>{energy.toFixed(0)} / 100</span>
                                    </div>
                                    <div className="h-3 bg-gray-700 rounded-full overflow-hidden">
                                        <div className="h-full bg-yellow-400 transition-all duration-300" style={{ width: `${energy}%` }}></div>
                                    </div>
                                </div>

                                <div>
                                    <div className="flex justify-between text-sm mb-1">
                                        <span className="flex items-center"><ThermometerIcon /> System Entropy (L_GC)</span>
                                        <span>{stress.toFixed(0)} / 100</span>
                                    </div>
                                    <div className="h-3 bg-gray-700 rounded-full overflow-hidden relative">
                                        <div className={`h-full transition-all duration-300 ${stress > PARAMS.THETA_CRIT ? 'bg-red-600' : 'bg-blue-400'}`} style={{ width: `${Math.min(100, stress)}%` }}></div>
                                        {/* Sapolsky Line */}
                                        <div className="absolute top-0 bottom-0 w-0.5 bg-white/50" style={{ left: `${PARAMS.THETA_CRIT}%` }} title="Sapolsky Limit"></div>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1 text-right">Sapolsky Limit: {PARAMS.THETA_CRIT}</p>
                                </div>
                            </div>

                            {/* ACTION BUTTONS */}
                            <div className="grid grid-cols-2 gap-4">
                                <button 
                                    onClick={handleConstruct} 
                                    disabled={isRewriting || isTruncated}
                                    className="p-4 bg-green-900/50 hover:bg-green-800 border border-green-600 rounded-lg flex flex-col items-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-center">
                                    <GitBranchIcon />
                                    <span className="font-bold text-green-100 block">Additive Construction</span>
                                    <span className="text-xs text-green-300 block">Build Layer (+1 Depth)</span>
                                </button>

                                <button 
                                    onClick={handleRewrite} 
                                    disabled={isRewriting}
                                    className="p-4 bg-purple-900/50 hover:bg-purple-800 border border-purple-600 rounded-lg flex flex-col items-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed text-center">
                                    <RefreshCwIcon />
                                    <span className="font-bold text-purple-100 block">Transformative Rewrite</span>
                                    <span className="text-xs text-purple-300 block">Dissolve & Rebuild (High Risk)</span>
                                </button>
                            </div>

                            <button 
                                onClick={handleStressSpike}
                                className="w-full p-3 bg-red-900/30 hover:bg-red-900/50 border border-red-800 rounded text-red-200 text-sm font-semibold transition-all">
                                Inject Environmental Shock (Spike L_GC)
                            </button>

                            {/* CHART */}
                            <div className="bg-gray-800 p-4 rounded-lg border border-gray-700 h-48">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={history}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#4b5563" />
                                        <XAxis dataKey="name" hide />
                                        <YAxis domain={[0, 100]} hide />
                                        <Tooltip contentStyle={{ backgroundColor: '#1f2937', border: 'none', color: '#fff' }} />
                                        <Legend />
                                        <Line type="monotone" dataKey="Energy" stroke="#facc15" dot={false} strokeWidth={2} />
                                        <Line type="monotone" dataKey="Stress" stroke="#ef4444" dot={false} strokeWidth={2} />
                                        <Line type="step" dataKey="EffectiveDepth" stroke="#4ade80" dot={false} strokeWidth={2} />
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    {/* FOOTER / TEACHING MOMENTS */}
                    <div className="mt-8 grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-400">
                        <div className="bg-black/20 p-4 rounded border border-gray-800">
                            <h3 className="text-white font-bold mb-2">1. The Cost of Depth</h3>
                            <p>Notice how <strong>Maintenance Cost</strong> rises as your tree grows deep. A complex mind (High L) requires massive energy to sustain. If you run out of energy, you cannot learn.</p>
                        </div>
                        <div className="bg-black/20 p-4 rounded border border-gray-800">
                            <h3 className="text-white font-bold mb-2">2. The Sapolsky Cliff</h3>
                            <p>Push stress past {PARAMS.THETA_CRIT} (the white line). Watch the tree turn <strong>RED</strong>. This is <strong>Truncation</strong>. You still "have" the depth, but you cannot access it. You are in Read-Only Mode.</p>
                        </div>
                        <div className="bg-black/20 p-4 rounded border border-gray-800">
                            <h3 className="text-white font-bold mb-2">3. The Butterfly Effect</h3>
                            <p>Try "Transformative Rewrite." Notice how Depth <strong>drops</strong> initially (Dissolution). You must survive the chaos (High Stress) to emerge with a deeper structure.</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
